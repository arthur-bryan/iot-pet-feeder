# Deployment Dependency Analysis

## Current State: Manual Steps Required

### Complete Destroy â†’ Recreate Workflow

#### 1. DESTROY PHASE
```bash
cd infra/terraform/environments/dev
terraform destroy -auto-approve
```

**What gets deleted:**
- All AWS resources (DynamoDB, Lambda, API Gateway, IoT Thing, Certificates, Amplify)
- Secrets Manager entries (certificates)
- IoT certificates are PERMANENTLY LOST

#### 2. RECREATE PHASE - Current Manual Steps

**Step 1: Configure Environment**
```bash
# Manual: Edit .env file
vim .env  # Add AWS credentials

# Manual: Edit terraform.tfvars
vim infra/terraform/environments/dev/terraform.tfvars
```

**Step 2: Run Terraform**
```bash
cd infra/terraform/environments/dev
set -a && source ../../../.env && set +a
terraform init
terraform plan -out=plan
terraform apply plan
```

**Step 3: Extract IoT Certificates (100% MANUAL)**
```bash
# Get secret ARNs from terraform output
CERT_ARN=$(terraform output -raw iot_certificate_pem_secret_arn)
KEY_ARN=$(terraform output -raw iot_private_key_pem_secret_arn)

# Download certificate
aws secretsmanager get-secret-value --secret-id $CERT_ARN --query SecretString --output text > cert.pem

# Download private key
aws secretsmanager get-secret-value --secret-id $KEY_ARN --query SecretString --output text > private.key

# Download root CA
curl https://www.amazontrust.com/repository/AmazonRootCA1.pem > root-ca.pem
```

**Step 4: Update ESP32 Firmware (100% MANUAL)**
```cpp
// Edit iot-pet-feeder.ino
const char* AWS_IOT_ENDPOINT = "a1mm0cek76sanp-ats.iot.us-east-2.amazonaws.com"; // From terraform output
const char* THING_NAME = "iot-pet-feeder-device-dev"; // From terraform output

// Paste certificates
const char AWS_CERT_CRT[] = "-----BEGIN CERTIFICATE-----\n..."; // From cert.pem
const char AWS_CERT_PRIVATE[] = "-----BEGIN RSA PRIVATE KEY-----\n..."; // From private.key
const char AWS_CERT_CA[] = "-----BEGIN CERTIFICATE-----\n..."; // From root-ca.pem
```

**Step 5: Flash ESP32**
```bash
# Open Arduino IDE / PlatformIO
# Select board, port
# Click Upload
# Monitor serial output
```

**Step 6: Verify Amplify Deployment**
```bash
# Check if Amplify built with correct API Gateway URL
# If wrong, manually trigger rebuild via AWS Console
```

**Total Manual Steps: ~15-20 actions**
**Time Required: 30-45 minutes**
**Error Prone: Very High**

---

## Identified Dependency Issues

### Issue 1: API Gateway â†’ Amplify Build Race Condition
**Problem:**
- Amplify starts building immediately when created
- API Gateway URL might not be ready or deployment incomplete
- Frontend gets wrong/empty API_BASE_URL

**Current State:**
```hcl
module "amplify_app" {
  environment_variables = {
    VITE_API_BASE_URL = module.api_gateway.api_gateway_invoke_url  # Implicit dependency
  }
}
```

**Impact:**
- First Amplify build might have incorrect API URL
- Requires manual rebuild trigger

**Solution:**
Add explicit dependency + post-deploy trigger:
```hcl
resource "null_resource" "trigger_amplify_build" {
  depends_on = [
    module.api_gateway,
    module.amplify_app
  ]

  provisioner "local-exec" {
    command = <<-EOT
      aws amplify start-job \
        --app-id ${module.amplify_app.app_id} \
        --branch-name dev \
        --job-type RELEASE \
        --region ${var.aws_region}
    EOT
  }

  triggers = {
    api_url = module.api_gateway.api_gateway_invoke_url
  }
}
```

### Issue 2: IoT Certificates â†’ ESP32 Firmware (CRITICAL)
**Problem:**
- Certificates generated by Terraform
- Stored in Secrets Manager
- Must be manually extracted and pasted into firmware
- No automation path

**Impact:**
- Completely blocks ESP32 setup
- High error rate (copy/paste mistakes)
- Not reproducible

**Solution:**
Add post-deployment script:
```bash
#!/bin/bash
# infra/scripts/generate-esp32-config.sh

cd infra/terraform/environments/dev

# Extract certificates
CERT_ARN=$(terraform output -raw iot_certificate_pem_secret_arn)
KEY_ARN=$(terraform output -raw iot_private_key_pem_secret_arn)
ENDPOINT=$(terraform output -raw iot_data_plane_endpoint)
THING=$(terraform output -raw iot_thing_name)

CERT=$(aws secretsmanager get-secret-value --secret-id $CERT_ARN --query SecretString --output text)
KEY=$(aws secretsmanager get-secret-value --secret-id $KEY_ARN --query SecretString --output text)
ROOT_CA=$(curl -s https://www.amazontrust.com/repository/AmazonRootCA1.pem)

# Generate secrets.h file
cat > ../../../firmware/esp32-feeder/iot-pet-feeder/secrets.h <<EOF
#ifndef SECRETS_H
#define SECRETS_H

const char* AWS_IOT_ENDPOINT = "$ENDPOINT";
const char* THING_NAME = "$THING";

const char AWS_CERT_CRT[] = R"EOF(
$CERT
)EOF";

const char AWS_CERT_PRIVATE[] = R"EOF(
$KEY
)EOF";

const char AWS_CERT_CA[] = R"EOF(
$ROOT_CA
)EOF";

#endif
EOF

echo "âœ… Generated firmware/esp32-feeder/iot-pet-feeder/secrets.h"
echo "ðŸ“ Update WiFi credentials in iot-pet-feeder.ino and flash to ESP32"
```

### Issue 3: Lambda Layer Version Drift
**Problem:**
- Manual deployment script updates Lambda to layer v3
- Terraform state shows layer v1
- Next terraform apply reverts to v1
- Requires manual re-update

**Impact:**
- Missing dependencies (email-validator)
- API errors

**Solution:**
Fix terraform state or update module to use latest layer version dynamically:
```hcl
data "aws_lambda_layer_version" "latest" {
  layer_name = module.python_dependencies_layer.layer_name
}

module "api_lambda" {
  layer_arns = [data.aws_lambda_layer_version.latest.arn]
}
```

### Issue 4: No Pre-flight Validation
**Problem:**
- No checks for required tools (terraform, aws cli, jq)
- No AWS credential validation
- No .env validation
- Fails mid-deployment

**Impact:**
- Wasted time
- Partial deployments

**Solution:**
Add validation script run before terraform.

### Issue 5: GitHub Token Exposure
**Problem:**
- GitHub token in terraform.tfvars or variables
- Stored in terraform state (plain text)
- Required for Amplify

**Impact:**
- Security risk if state leaked

**Solution:**
Use environment variable:
```hcl
variable "github_token" {
  type      = string
  sensitive = true
  default   = env("TF_VAR_github_token")
}
```

---

## Proposed Automated Workflow

### Target User Experience
```bash
# One-time setup
git clone <repo>
cp .env.example .env              # Edit AWS credentials
cp terraform.tfvars.example terraform.tfvars  # Edit project config
make setup                        # One command does everything

# After destroy
make deploy                       # Recreates everything
make flash-esp32                  # Compiles and flashes firmware (if ESP32 connected)
```

### What `make setup` should do:
1. âœ… Validate environment (tools, credentials)
2. âœ… Run terraform init/plan/apply
3. âœ… Extract IoT certificates
4. âœ… Generate secrets.h for ESP32
5. âœ… Trigger Amplify rebuild (ensure correct API URL)
6. âœ… Output next steps for user
7. âœ… Generate deployment summary

### Scripts Needed

**1. infra/scripts/validate.sh** - Pre-flight checks
**2. infra/scripts/generate-esp32-config.sh** - Certificate extraction
**3. infra/scripts/post-deploy.sh** - Amplify rebuild, verification
**4. infra/scripts/setup.sh** - Orchestrates everything
**5. Makefile** - Simple commands

---

## Automation Priority

| Issue | Impact | Effort | Priority |
|-------|--------|--------|----------|
| IoT Cert â†’ ESP32 | CRITICAL | Low | ðŸ”´ P0 |
| API GW â†’ Amplify race | High | Low | ðŸŸ  P1 |
| Pre-flight validation | High | Low | ðŸŸ  P1 |
| Lambda layer drift | Medium | Medium | ðŸŸ¡ P2 |
| Example configs | Medium | Low | ðŸŸ¡ P2 |
| ESP32 auto-flash | Low | High | ðŸŸ¢ P3 |

---

## Remaining Manual Steps (After Automation)

Even with full automation, users still need to:

1. **Edit .env** - AWS credentials (unavoidable)
2. **Edit terraform.tfvars** - Project settings (can provide good defaults)
3. **WiFi credentials** - Edit in secrets.h or iot-pet-feeder.ino
4. **Flash ESP32** - Physical connection + Arduino IDE/PlatformIO (can script if board connected)

**Target: 4 manual steps (down from 15-20)**
